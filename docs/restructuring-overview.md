# NcatBot 重构总览

## 项目结构

NcatBot 重构后的项目结构将分为四个主要模块：

1. [核心模块（Core）](core-module-spec.md) - 负责 Bot 实例管理与 NAPCAT 通信
2. [插件系统（Plugin System）](plugin-system-spec.md) - 负责插件加载、事件处理与权限管理
3. [命令行工具（CLI）](cli-module-spec.md) - 负责用户交互与系统管理
4. [工具模块（Utils）](utils-module-spec.md) - 提供公共工具与辅助功能

## 重构目标

- 分离关注点，提高代码的可维护性和可扩展性
- 统一接口设计，提供更一致的开发体验
- 提供更灵活的插件管理与权限控制
- 改善配置系统，使配置作为实例在系统间传递
- 标准化消息处理流程，收发消息均使用统一的 MessageElement 对象
- 通过插件系统提供的 EventBus 实现事件上报
- 保持向后兼容性，确保现有插件可继续使用

## 实现计划

1. **阶段一：结构重组**
   - 按照新的模块划分重组代码
   - 确定各模块间的依赖关系
   - 设计并实现各模块的接口
   - 建立统一的消息元素体系

2. **阶段二：核心功能增强**
   - 优化消息处理流程
   - 实现 MessageElement 和 MessageChain
   - 设计 Core 与插件系统的事件传递机制
   - 改进权限系统

3. **阶段三：工具与接口完善**
   - 完善 CLI 工具
   - 统一错误处理
   - 加强日志系统
   - 完善消息元素的序列化与反序列化

4. **阶段四：测试与文档**
   - 为核心功能编写测试
   - 完善开发者文档
   - 提供升级指南
   - 编写消息处理相关示例

## 特别注意

- 配置应该作为实例在各个系统中传递，而非作为全局变量使用
- 保留现有的启动方式（阻塞模式启动，插件模式启动）
- 消息处理需要标准化，收发消息均使用 MessageElement
- 核心模块需要通过插件系统的 EventBus 进行事件上报
- CLI、插件系统、本体放在同一个仓库，打包为一个 PYPI pkg 发布 